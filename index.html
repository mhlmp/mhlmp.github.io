<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Link Manager Pro - Clean Build</title>
    <style>
        :root {
            /* Theme Variables */
            --bg-body: #f4f7f6;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --backdrop: blur(12px);
            
            --text-main: #2d3748;
            --text-muted: #718096;
            --primary: #3182ce;
            --primary-hover: #2b6cb0;
            --success: #38a169;
            --danger: #e53e3e;
            --gold: #d69e2e;
            --card-bg: rgba(255, 255, 255, 0.6);
        }

        body.dark-mode {
            --bg-body: #1a202c;
            --glass-bg: rgba(26, 32, 44, 0.8);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            
            --text-main: #f7fafc;
            --text-muted: #a0aec0;
            --primary: #63b3ed;
            --primary-hover: #4299e1;
            --card-bg: rgba(45, 55, 72, 0.6);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            padding-bottom: 100px;
            transition: background 0.3s, color 0.3s;
            background-image: radial-gradient(circle at 10% 20%, rgba(49, 130, 206, 0.05) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(229, 62, 62, 0.05) 0%, transparent 20%);
            background-attachment: fixed;
        }

        /* --- Glassmorphism Utils --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop);
            -webkit-backdrop-filter: var(--backdrop);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
        }

        /* --- Layout --- */
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-weight: 800; font-size: 2rem; margin: 0; background: linear-gradient(135deg, var(--primary), #805ad5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* --- User Bar --- */
        .user-bar {
            padding: 15px 20px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 10px;
        }
        .user-left { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--glass-border); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e0; display: inline-block; margin-left: 5px; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.syncing { background: var(--gold); animation: pulse 1s infinite; }
        
        .btn-google { background: #4285F4; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .btn-google:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); }
        .btn-ghost { background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted); padding: 6px 12px; border-radius: 8px; cursor: pointer; }
        .btn-ghost:hover { background: rgba(127,127,127,0.1); color: var(--text-main); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- Controls --- */
        .controls { padding: 20px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .search-wrapper input {
            width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--glass-border);
            background: rgba(127,127,127,0.05); color: var(--text-main); font-size: 1rem;
            transition: all 0.2s;
        }
        .search-wrapper input:focus { background: rgba(127,127,127,0.1); border-color: var(--primary); }

        .filters-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .filters-row select {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--glass-border);
            background: var(--bg-body); color: var(--text-main); cursor: pointer;
        }
        
        .actions-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        .action-btn {
            padding: 10px 16px; border-radius: 10px; border: none; cursor: pointer; color: white; font-weight: 600;
            display: flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.96); }
        .btn-blue { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .btn-cyan { background: linear-gradient(135deg, #4fd1c5, #38b2ac); }
        .btn-indigo { background: linear-gradient(135deg, #667eea, #5a67d8); }
        .btn-icon { background: rgba(127,127,127,0.1); color: var(--text-main); width: 40px; justify-content: center; }

        /* --- Dropdowns --- */
        .dropdown { position: relative; }
        .dropdown-menu {
            display: none; position: absolute; top: 100%; right: 0; width: 220px;
            background: var(--bg-body); border: 1px solid var(--glass-border);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-radius: 12px; z-index: 2000;
            padding: 5px; margin-top: 5px;
        }
        .dropdown-menu.show { display: block; animation: slideDown 0.2s ease; }
        .dropdown-menu button, .dropdown-menu label {
            display: block; width: 100%; padding: 10px; text-align: right; background: none; border: none;
            color: var(--text-main); cursor: pointer; border-radius: 6px; font-size: 0.9rem;
        }
        .dropdown-menu button:hover { background: rgba(127,127,127,0.1); color: var(--primary); }
        input[type="file"] { display: none; }

        /* --- Add Form --- */
        .add-panel { margin-bottom: 30px; overflow: hidden; }
        .add-panel summary { padding: 15px; font-weight: bold; cursor: pointer; color: var(--primary); user-select: none; }
        .form-content { padding: 20px; padding-top: 0; display: flex; flex-direction: column; gap: 10px; }
        .form-content input, .form-content textarea {
            padding: 12px; border-radius: 10px; border: 1px solid var(--glass-border);
            background: rgba(127,127,127,0.05); color: var(--text-main); width: 100%;
        }
        .btn-submit { background: var(--success); color: white; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }

        /* --- Grid & Cards --- */
        .category-title { font-size: 1.2rem; font-weight: 700; margin: 30px 0 15px 0; padding-bottom: 5px; border-bottom: 2px solid rgba(127,127,127,0.1); display: flex; justify-content: space-between; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        .card {
            position: relative;
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s, z-index 0s; /* No Layout Shift */
        }

        /* Hover Effect - Only if menu is NOT open */
        .card:not(.menu-active):hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            z-index: 10;
        }

        /* Pinned State */
        .card.pinned { border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(214, 158, 46, 0.3); }

        /* MENU ACTIVE STATE (The Fix) */
        .card.menu-active {
            z-index: 100 !important; /* Force on top */
            transform: none !important; /* Reset position */
            box-shadow: 0 0 0 3px var(--primary) !important; /* Highlight */
        }

        .card-body { padding: 20px; flex: 1; }
        .card-index { position: absolute; top: 10px; left: 10px; font-size: 0.75rem; color: var(--text-muted); opacity: 0.7; }
        .card-link { font-weight: 700; color: var(--primary); text-decoration: none; font-size: 1.05rem; display: block; margin-bottom: 8px; word-break: break-all; }
        .card-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; margin-bottom: 10px; }
        .card-note { background: rgba(255, 255, 0, 0.15); color: #b7791f; padding: 8px; border-radius: 8px; font-size: 0.85rem; border-right: 3px solid var(--gold); }
        .dark-mode .card-note { background: rgba(214, 158, 46, 0.2); color: #ecc94b; }

        .card-footer {
            padding: 12px 20px; border-top: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(127,127,127,0.03); border-radius: 0 0 16px 16px;
        }

        .card-actions { display: flex; gap: 5px; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 5px; border-radius: 50%; transition: 0.2s; font-size: 1.1rem; }
        .icon-btn:hover { color: var(--primary); background: rgba(127,127,127,0.1); }
        .icon-btn.pinned { color: var(--gold); transform: rotate(45deg); }

        /* POPUP MENU */
        .popup-menu {
            display: none; position: absolute;
            bottom: 50px; left: 10px; /* Anchored safely */
            background: var(--bg-body); border: 1px solid var(--glass-border);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); border-radius: 10px;
            width: 140px; overflow: hidden; z-index: 200;
        }
        .popup-menu.open { display: block; animation: fadeIn 0.1s; }
        .popup-menu button {
            width: 100%; padding: 12px; text-align: right; background: none; border: none;
            color: var(--danger); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .popup-menu button:hover { background: rgba(229, 62, 62, 0.1); }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 100px);
            background: #2d3748; color: white; padding: 12px 24px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0; z-index: 5000; display: flex; gap: 15px; align-items: center;
        }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }
        .toast button { background: none; border: none; color: var(--success); font-weight: bold; cursor: pointer; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="dark-mode"> <div class="container">
        <header>
            <h1>Link Manager Pro</h1>
            <div id="stats" style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        </header>

        <div class="glass user-bar">
            <div id="authLoggedOut" style="display:none; width: 100%; justify-content: center;">
                <button id="btnLogin" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.2,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.1,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z"/></svg>
                    ×”×ª×—×‘×¨ ×¢× Google
                </button>
            </div>
            <div id="authLoggedIn" style="display:none; width: 100%; justify-content: space-between; align-items: center;">
                <div class="user-left">
                    <img id="userImg" src="" class="avatar" alt="User">
                    <div>
                        <div id="userName" style="font-weight:700;">User</div>
                        <div id="syncStatus" style="font-size: 0.8rem; color: var(--text-muted);"><span class="status-dot"></span> ×× ×•×ª×§</div>
                    </div>
                </div>
                <div>
                    <button id="btnSwitch" class="btn-ghost">ğŸ”„ ×”×—×œ×£</button>
                    <button id="btnLogout" class="btn-ghost">×™×¦×™××”</button>
                </div>
            </div>
        </div>

        <div class="glass controls">
            <div class="search-wrapper">
                <input type="search" id="searchInput" placeholder="ğŸ” ×—×™×¤×•×© ××”×™×¨...">
            </div>
            
            <div class="filters-row">
                <select id="categoryFilter"><option value="">ğŸ“‚ ×›×œ ×”×§×˜×’×•×¨×™×•×ª</option></select>
                <select id="sortSelect">
                    <option value="date-new" selected>ğŸ“… ×ª××¨×™×š (×—×“×© ×œ×™×©×Ÿ)</option>
                    <option value="index-new">ğŸ”¢ ×¡×“×¨ ×”×•×¡×¤×” (×—×“×©)</option>
                    <option value="index-old">ğŸ”¢ ×¡×“×¨ ×”×•×¡×¤×” (×™×©×Ÿ)</option>
                    <option value="name">ğŸ”¤ ×©× (×-×ª)</option>
                </select>
            </div>

            <div class="actions-row">
                <div class="dropdown">
                    <button class="action-btn btn-blue" onclick="toggleDropdown('jsonMenu', event)">ğŸ“‚ JSON â–¼</button>
                    <div id="jsonMenu" class="dropdown-menu">
                        <label for="importJson">ğŸ“¥ ×™×™×‘×•× ×§×•×‘×¥</label>
                        <input type="file" id="importJson" accept=".json">
                        <button id="btnExportJson">ğŸ“¤ ×™×™×¦×•× ×œ×§×•×‘×¥</button>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="action-btn btn-cyan" onclick="toggleDropdown('txtMenu', event)">ğŸ“„ ×˜×§×¡×˜ â–¼</button>
                    <div id="txtMenu" class="dropdown-menu">
                        <button id="btnExportTxt">ğŸ“¤ ×™×™×¦×•× ×œ-TXT</button>
                        <label for="importTxt">ğŸ”„ ××™×–×•×’ ×—×›×</label>
                        <input type="file" id="importTxt" accept=".txt">
                    </div>
                </div>
                <div class="dropdown">
                    <button class="action-btn btn-indigo" onclick="toggleDropdown('siteMenu', event)">ğŸ’¾ ××ª×¨ â–¼</button>
                    <div id="siteMenu" class="dropdown-menu">
                        <button id="btnSaveHtml">×©××•×¨ ×›-HTML</button>
                    </div>
                </div>
                <button id="btnToggleTheme" class="action-btn btn-icon">â˜€ï¸</button>
            </div>
        </div>

        <details class="glass add-panel">
            <summary>â• ×”×•×¡×¤×ª ×§×™×©×•×¨ ×—×“×©</summary>
            <form id="addForm" class="form-content">
                <textarea id="inpContent" rows="2" placeholder="×”×“×‘×§ ×›××Ÿ ×§×™×©×•×¨ ××• ×˜×§×¡×˜..." required></textarea>
                <input type="text" id="inpDesc" placeholder="×ª×™××•×¨">
                <input type="text" id="inpCat" list="catList" placeholder="×§×˜×’×•×¨×™×” (×‘×¨×™×¨×ª ××—×“×œ: ×›×œ×œ×™)">
                <datalist id="catList"></datalist>
                <input type="text" id="inpNote" placeholder="×”×¢×¨×” ×¦×”×•×‘×” (××•×¤×¦×™×•× ×œ×™)">
                <button type="submit" class="btn-submit">×©××•×¨ ×¤×¨×™×˜</button>
            </form>
        </details>

        <div id="mainGrid" class="container"></div>

    </div>

    <div id="toast" class="toast">
        <span id="toastMsg">×”×•×“×¢×”</span>
        <button id="btnUndo">×‘×˜×œ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnRk-Os6EvJcFIdpl-lICc9w-E4pQ74nE",
            authDomain: "linkmanager-fdac5.firebaseapp.com",
            projectId: "linkmanager-fdac5",
            storageBucket: "linkmanager-fdac5.firebasestorage.app",
            messagingSenderId: "532683691813",
            appId: "1:532683691813:web:5cf639e32a715c626eeccc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        // Export Auth Functions globally
        window.fbLogin = async () => { try { await signInWithPopup(auth, provider); } catch(e) { alert(e.message); } };
        window.fbLogout = async () => { await signOut(auth); location.reload(); };
        window.fbSwitch = async () => { if(confirm('×”×—×œ×£ ×—×©×‘×•×Ÿ?')) { await signOut(auth); window.fbLogin(); } };

        let unsubscribe = null;

        onAuthStateChanged(auth, user => {
            const loginUI = document.getElementById('authLoggedOut');
            const userUI = document.getElementById('authLoggedIn');
            
            if (user) {
                loginUI.style.display = 'none';
                userUI.style.display = 'flex';
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userImg').src = user.photoURL;
                updateStatus('syncing');

                if (unsubscribe) unsubscribe();
                unsubscribe = onSnapshot(doc(db, "users", user.uid), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data().items || [];
                        if (JSON.stringify(data) !== JSON.stringify(window.items)) {
                            window.items = data;
                            appLogic.onDataUpdate(false);
                        }
                        updateStatus('online');
                    } else {
                        if (window.items.length > 0) window.syncToCloud(); 
                        else updateStatus('online');
                    }
                });

                window.syncToCloud = async () => {
                    updateStatus('syncing');
                    try {
                        await setDoc(doc(db, "users", user.uid), { items: window.items, updated: new Date().toISOString() });
                    } catch(e) { console.error(e); updateStatus('error'); }
                };
            } else {
                loginUI.style.display = 'flex';
                userUI.style.display = 'none';
                window.syncToCloud = null;
            }
        });

        function updateStatus(state) {
            const el = document.getElementById('syncStatus');
            const dot = el.querySelector('.status-dot');
            dot.className = 'status-dot ' + state;
            el.innerHTML = state === 'online' ? '<span class="status-dot online"></span> ××¡×•× ×›×¨×Ÿ' : 
                           state === 'syncing' ? '<span class="status-dot syncing"></span> ××¡× ×›×¨×Ÿ...' : 
                           '<span class="status-dot"></span> ×× ×•×ª×§';
        }
    </script>

    <script>
        const STORAGE_KEY = 'LinkManager_Clean_V1';
        
        // --- State ---
        window.items = [];
        let undoStack = null;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadLocal();
            appLogic.initListeners();
            appLogic.render();
            
            // Restore Theme
            if(localStorage.getItem('theme') === 'light') {
                document.body.classList.remove('dark-mode');
                document.getElementById('btnToggleTheme').textContent = 'ğŸŒ™';
            }
        });

        // --- Logic Module ---
        const appLogic = {
            initListeners: () => {
                // Global Click to close menus
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.popup-menu') && !e.target.closest('.menu-trigger')) {
                        appLogic.closeAllMenus();
                    }
                    if (!e.target.closest('.dropdown')) {
                        document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.remove('show'));
                    }
                });

                document.getElementById('addForm').addEventListener('submit', appLogic.add);
                document.getElementById('searchInput').addEventListener('input', () => requestAnimationFrame(appLogic.render));
                document.getElementById('categoryFilter').addEventListener('change', appLogic.render);
                document.getElementById('sortSelect').addEventListener('change', appLogic.render);
                
                document.getElementById('btnToggleTheme').onclick = () => {
                    document.body.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    document.getElementById('btnToggleTheme').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
                };

                // Auth Buttons
                document.getElementById('btnLogin').onclick = () => window.fbLogin && window.fbLogin();
                document.getElementById('btnLogout').onclick = () => window.fbLogout && window.fbLogout();
                document.getElementById('btnSwitch').onclick = () => window.fbSwitch && window.fbSwitch();

                // Import/Export
                document.getElementById('btnExportJson').onclick = () => utils.download('links.json', JSON.stringify(window.items, null, 2), 'application/json');
                document.getElementById('btnExportTxt').onclick = () => utils.download('links.txt', window.items.map(i => `${i.content}|${i.desc}|${i.cat}`).join('\n'), 'text/plain');
                document.getElementById('btnSaveHtml').onclick = () => {
                    const html = `<!DOCTYPE html>${document.documentElement.outerHTML}`;
                    utils.download('manager.html', html, 'text/html');
                };
                
                document.getElementById('importJson').onchange = (e) => utils.readFile(e, (res) => {
                    try { window.items = JSON.parse(res); appLogic.onDataUpdate(); alert('× ×˜×¢×Ÿ ×‘×”×¦×œ×—×”'); } catch(e) { alert('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ'); }
                });
                
                document.getElementById('importTxt').onchange = (e) => utils.readFile(e, (res) => {
                    const lines = res.split('\n');
                    let count = 0;
                    lines.forEach(line => {
                        const [c, d, cat] = line.split('|');
                        if(c && !window.items.find(i => i.content === c.trim())) {
                            window.items.unshift(utils.createItem(c, d, cat));
                            count++;
                        }
                    });
                    appLogic.onDataUpdate();
                    alert(`× ×•×¡×¤×• ${count} ×¤×¨×™×˜×™×`);
                });

                document.getElementById('btnUndo').onclick = () => {
                    if(!undoStack) return;
                    if(undoStack.action === 'del') window.items.splice(undoStack.idx, 0, undoStack.item);
                    appLogic.onDataUpdate();
                    document.getElementById('toast').classList.remove('show');
                }
            },

            add: (e) => {
                e.preventDefault();
                const content = document.getElementById('inpContent').value.trim();
                const desc = document.getElementById('inpDesc').value.trim();
                const cat = document.getElementById('inpCat').value.trim();
                const note = document.getElementById('inpNote').value.trim();
                
                if(!content) return;
                
                const item = utils.createItem(content, desc, cat, note);
                window.items.unshift(item);
                appLogic.onDataUpdate();
                e.target.reset();
                utils.showToast('×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”');
            },

            delete: (id) => {
                if(!confirm('×œ××—×•×§?')) return;
                const idx = window.items.findIndex(i => i.id == id);
                if(idx > -1) {
                    const item = window.items[idx];
                    window.items.splice(idx, 1);
                    undoStack = { action: 'del', item, idx };
                    appLogic.onDataUpdate();
                    utils.showToast('×”×¤×¨×™×˜ × ××—×§', true);
                }
            },

            togglePin: (id) => {
                const item = window.items.find(i => i.id == id);
                if(item) {
                    item.pinned = !item.pinned;
                    appLogic.onDataUpdate();
                }
            },

            edit: (id) => {
                const item = window.items.find(i => i.id == id);
                if(!item) return;
                const nc = prompt('×ª×•×›×Ÿ:', item.content);
                if(nc === null) return;
                item.content = nc;
                item.desc = prompt('×ª×™××•×¨:', item.desc) || '';
                item.cat = prompt('×§×˜×’×•×¨×™×”:', item.cat) || '×›×œ×œ×™';
                item.note = prompt('×”×¢×¨×”:', item.note) || '';
                appLogic.onDataUpdate();
            },

            onDataUpdate: (sync = true) => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(window.items));
                appLogic.updateCats();
                appLogic.render();
                if(sync && window.syncToCloud) window.syncToCloud();
            },

            updateCats: () => {
                const cats = [...new Set(window.items.map(i => i.cat))].sort();
                const sel = document.getElementById('categoryFilter');
                const list = document.getElementById('catList');
                const curr = sel.value;
                
                sel.innerHTML = '<option value="">ğŸ“‚ ×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
                list.innerHTML = cats.map(c => `<option value="${c}">`).join('');
                sel.value = curr;
            },

            closeAllMenus: () => {
                document.querySelectorAll('.popup-menu').forEach(el => el.classList.remove('open'));
                document.querySelectorAll('.card').forEach(el => el.classList.remove('menu-active')); // Remove Lock
            },

            render: () => {
                const grid = document.getElementById('mainGrid');
                grid.innerHTML = '';
                
                const q = document.getElementById('searchInput').value.toLowerCase();
                const catFilter = document.getElementById('categoryFilter').value;
                const sortMode = document.getElementById('sortSelect').value;

                let list = window.items.filter(i => {
                    const txt = (i.content + i.desc + i.cat + i.note).toLowerCase();
                    return txt.includes(q) && (!catFilter || i.cat === catFilter);
                });

                document.getElementById('stats').textContent = `××¦×™×’ ${list.length} ××ª×•×š ${window.items.length}`;

                // Sort Logic
                list.sort((a, b) => {
                    if (a.pinned !== b.pinned) return b.pinned ? 1 : -1; // Pinned always first
                    if (sortMode === 'date-new') return b.date.localeCompare(a.date); // Default
                    if (sortMode === 'name') return a.content.localeCompare(b.content);
                    if (sortMode === 'index-new') return 0; // Natural order (newest is usually first in array)
                    if (sortMode === 'index-old') return 0; // Handle reverse in display loop
                    return 0;
                });
                
                if (sortMode === 'index-old') list.reverse();

                // Group by Category
                const groups = {};
                list.forEach(i => {
                    if(!groups[i.cat]) groups[i.cat] = [];
                    groups[i.cat].push(i);
                });

                Object.keys(groups).sort().forEach(cat => {
                    const title = document.createElement('div');
                    title.className = 'category-title';
                    title.innerHTML = `<span>${cat}</span><span style="font-size:0.8em; opacity:0.6">${groups[cat].length}</span>`;
                    grid.appendChild(title);

                    const catGrid = document.createElement('div');
                    catGrid.className = 'grid';
                    
                    groups[cat].forEach((item, idx) => {
                        catGrid.appendChild(appLogic.buildCard(item, idx + 1));
                    });
                    grid.appendChild(catGrid);
                });
            },

            buildCard: (item, num) => {
                const div = document.createElement('div');
                div.className = `card ${item.pinned ? 'pinned' : ''}`;
                
                const isLink = /^(http|t\.me)/.test(item.content);
                const contentHtml = isLink 
                    ? `<a href="${item.content}" target="_blank" class="card-link">${item.content}</a>`
                    : `<div class="card-link" style="color:var(--text-main)">${item.content}</div>`;

                const noteHtml = item.note ? `<div class="card-note">ğŸ“ ${item.note}</div>` : '';

                div.innerHTML = `
                    <div class="card-index">#${num}</div>
                    <div class="card-body">
                        ${contentHtml}
                        <div class="card-desc">${item.desc}</div>
                        ${noteHtml}
                    </div>
                    <div class="card-footer">
                        <span style="font-size:0.8rem; opacity:0.7">${item.cat}</span>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="utils.copy('${item.content}')">ğŸ“‹</button>
                            <button class="icon-btn" onclick="appLogic.edit(${item.id})">âœï¸</button>
                            <button class="icon-btn ${item.pinned?'pinned':''}" onclick="appLogic.togglePin(${item.id})">ğŸ“Œ</button>
                            <button class="icon-btn menu-trigger" style="color:var(--danger)" onclick="appLogic.toggleMenu(this, ${item.id})">â‹®</button>
                        </div>
                    </div>
                    <div id="menu-${item.id}" class="popup-menu">
                        <button onclick="appLogic.delete(${item.id})">ğŸ—‘ï¸ ××—×§</button>
                    </div>
                `;
                return div;
            },

            toggleMenu: (btn, id) => {
                // Stop propagation handled by logic
                const menu = document.getElementById(`menu-${id}`);
                const card = btn.closest('.card');
                const wasOpen = menu.classList.contains('open');

                appLogic.closeAllMenus(); // Close others

                if (!wasOpen) {
                    menu.classList.add('open');
                    card.classList.add('menu-active'); // LOCK THE CARD (Fixes Jitter)
                }
            }
        };

        // --- Utilities ---
        const utils = {
            createItem: (content, desc='', cat='×›×œ×œ×™', note='') => ({
                id: Date.now() + Math.random(),
                content: content.trim(),
                desc: desc.trim(),
                cat: cat.trim() || '×›×œ×œ×™',
                note: note.trim(),
                date: new Date().toISOString(),
                pinned: false
            }),
            copy: (txt) => {
                navigator.clipboard.writeText(txt);
                utils.showToast('×”×•×¢×ª×§ ×œ×œ×•×—');
            },
            showToast: (msg, allowUndo=false) => {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').textContent = msg;
                document.getElementById('btnUndo').style.display = allowUndo ? 'block' : 'none';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            download: (name, content, type) => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([content], {type}));
                a.download = name;
                a.click();
            },
            readFile: (e, cb) => {
                const f = e.target.files[0];
                if(f) { const r = new FileReader(); r.onload = (ev) => cb(ev.target.result); r.readAsText(f); }
                e.target.value = '';
            }
        };

        // Dropdown Helper
        window.toggleDropdown = (id, e) => {
            e.stopPropagation();
            document.querySelectorAll('.dropdown-menu').forEach(el => {
                if(el.id !== id) el.classList.remove('show');
            });
            document.getElementById(id).classList.toggle('show');
        };

        function loadLocal() {
            try {
                // Try embed first (for saved HTML files)
                // If not, try localStorage
                const local = localStorage.getItem(STORAGE_KEY);
                if(local) window.items = JSON.parse(local);
            } catch(e) { console.log('New session'); }
        }
    </script>
</body>
</html>
